# 🔍 근본 원인 파악 - 오류 확인 방법

## ✅ 강화된 디버깅 적용 완료

이제 모든 오류가 **콘솔 + 파일(ai_error_log.txt)**에 기록됩니다.

---

## 📋 즉시 확인 방법

### 방법 1: 포그라운드 실행 (권장)

터미널에서 직접 로그를 보면서 확인:

```bash
$env:PYTHONIOENCODING="utf-8"; python app.py
```

그 다음:
1. 브라우저에서 http://localhost:5000 접속
2. 회사 검색 후 "AI로 재무제표 설명 생성" 클릭
3. **터미널을 주시하세요!**

예상 로그:
```
================================================================================
❌ Gemini API 호출 오류 (시도 1/5)
   오류 타입: [실제 오류 타입]
   오류 메시지 (전체): [실제 오류 메시지]
   전체 오류 객체: [오류 객체]
   예외 속성: {...}
   HTTP 상태 코드: [있다면]
   args: [...]
================================================================================
🔍 status_code 감지: [있다면]
→ [판단 결과]
```

### 방법 2: 백그라운드 실행 + 로그 파일 확인

```bash
# 1. 서버 시작
$env:PYTHONIOENCODING="utf-8"; python app.py &

# 2. 브라우저 테스트
# http://localhost:5000 접속 → AI 버튼 클릭

# 3. 로그 파일 확인
cat ai_error_log.txt
```

---

## 🎯 확인해야 할 핵심 정보

### 1. 오류 타입

```
   오류 타입: ValueError
```

**가능한 타입들**:
- `PermissionDenied` → API 키 문제 (401)
- `ResourceExhausted` → 할당량 초과 (429)
- `NotFound` → 모델 없음 (404)
- `ValueError` → 응답 파싱 실패
- `ConnectionError` → 네트워크 문제
- `TimeoutError` → 타임아웃

### 2. 오류 메시지

```
   오류 메시지 (전체): [실제 메시지]
```

**확인할 키워드**:
- `API_KEY_INVALID` → 진짜 API 키 오류
- `Model not found` → 모델 이름 오류
- `RESOURCE_EXHAUSTED` → 할당량 초과
- `Response validation` → 파싱 오류 (재시도해야 함)
- `Safety` / `BLOCKED` → 콘텐츠 필터

### 3. HTTP 상태 코드

```
   HTTP 상태 코드: 401
```

**의미**:
- `401` → 인증 실패 (API 키 확인 필요)
- `429` → 요청 과다 (할당량)
- `404` → 리소스 없음 (모델)
- 없음 → 파싱 오류 등 (재시도)

### 4. 판단 로직 확인

```
🔍 status_code 감지: 401
🔍 401 오류 - 메시지에서 키워드 검색 중...
→ HTTP 401이지만 API 키 키워드 없음, 재시도
→ 검색한 키워드: ['API_KEY_INVALID', 'INVALID_API_KEY', ...]
→ 실제 메시지: [...]
```

**이 부분이 가장 중요!**
- 만약 "HTTP 401이지만 API 키 키워드 없음, 재시도"라고 나온다면?
  → **API 키는 정상이지만 다른 401 오류**입니다!

---

## 🔬 예상 시나리오

### 시나리오 1: 진짜 API 키 오류 (거의 없을 것)

```
오류 타입: PermissionDenied
HTTP 상태 코드: 401
오류 메시지: API_KEY_INVALID
→ 100% 확실한 API 키 오류 (발견된 키워드: ['API_KEY_INVALID'])
```

**해결**: API 키 재확인 또는 재발급

### 시나리오 2: Safety 필터 차단

```
오류 타입: ValueError
오류 메시지: Response blocked by safety filter
🔍 status_code 속성 없음
→ 콘텐츠 필터링 오류 감지
```

**해결**: Safety settings이 이미 BLOCK_NONE인데도 발생하면 프롬프트 수정 필요

### 시나리오 3: 응답 파싱 오류 (가장 가능성 높음)

```
오류 타입: ValueError  
오류 메시지: Response validation failed
🔍 status_code 속성 없음
→ 일시적 오류로 판단하고 재시도
```

**해결**: 자동 재시도됨 (5회까지)

### 시나리오 4: 할당량 초과

```
오류 타입: ResourceExhausted
HTTP 상태 코드: 429
오류 메시지: RESOURCE_EXHAUSTED
→ 할당량 초과 오류 감지
```

**해결**: 몇 분 대기 후 재시도

---

## 🚀 지금 바로 실행

### 1단계: 서버 시작 (포그라운드)

```bash
$env:PYTHONIOENCODING="utf-8"; python app.py
```

### 2단계: 브라우저 테스트

1. http://localhost:5000
2. "삼성전자" 검색
3. AI 버튼 클릭
4. **터미널 로그를 스크린샷 또는 텍스트로 복사**

### 3단계: 로그 분석

터미널에 출력된 내용을 확인하고:

- **오류 타입은?**
- **오류 메시지는?**
- **HTTP 상태 코드는?**
- **어떻게 판단했는가?**

---

## 💡 예상 근본 원인

test_gemini.py는 성공하는데 웹 앱은 실패한다면:

### 가능성 1: 재무 데이터가 너무 김
- **증상**: 프롬프트가 너무 길어서 오류
- **확인**: 오류 메시지에 "token" 또는 "length" 언급
- **해결**: 데이터 요약 또는 토큰 제한

### 가능성 2: Safety 필터
- **증상**: "SAFETY" 또는 "BLOCKED" 메시지
- **확인**: 이미 BLOCK_NONE인데도 발생
- **해결**: 프롬프트 수정 (재무 용어 조정)

### 가능성 3: 일시적 오류를 잘못 판단
- **증상**: ValueError, AttributeError 등
- **확인**: status_code 없는데 API 키 오류로 판단됨
- **해결**: 코드 로직 수정 (이미 완료)

---

## 📞 다음 단계

1. **서버를 포그라운드로 실행**
2. **AI 버튼 클릭**
3. **터미널 로그 전체를 확인**
4. **로그를 공유** (또는 스크린샷)

그러면 **정확한 근본 원인**을 파악하고 해결할 수 있습니다!

