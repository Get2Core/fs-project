# 배포 후 문제 해결 가이드 🔧

배포 후 발생할 수 있는 문제들과 해결 방법을 정리했습니다.

---

## 🔍 문제 1: 회사명 검색이 작동하지 않음

### 증상
- 검색창에 회사명을 입력해도 결과가 나오지 않음
- 자동완성이 작동하지 않음
- 콘솔에 오류 메시지 표시

### 원인
1. **`corp_codes.json` 파일이 생성되지 않음** (가장 흔한 원인)
2. OpenDart API 키가 제대로 설정되지 않음
3. 빌드 시 `download_corp_code.py` 실행 실패

### 해결 방법

#### ✅ 1단계: 서버 상태 확인

배포된 URL에 `/api/health`를 붙여서 접속:
```
https://your-app.onrender.com/api/health
```

**정상적인 응답:**
```json
{
  "status": "ok",
  "companies_loaded": 147890,  // 0이 아닌 큰 숫자여야 함
  "api_key_configured": true,
  "gemini_configured": true,
  "data_file_exists": true
}
```

**문제가 있는 응답:**
```json
{
  "status": "warning",
  "companies_loaded": 0,        // ❌ 문제!
  "api_key_configured": false,  // ❌ API 키 문제
  "data_file_exists": false,    // ❌ 파일 없음
  "warning": "회사 데이터가 로드되지 않았습니다."
}
```

#### ✅ 2단계: 환경 변수 확인

**Render:**
1. Dashboard → 서비스 선택
2. "Environment" 탭 클릭
3. 다음 변수가 있는지 확인:
   ```
   OPENDART_API_KEY=실제_40자리_키
   GEMINI_API_KEY=실제_키
   ```

**중요:** 
- 앞뒤 공백 없이 입력
- 따옴표 없이 입력
- 키가 정확한지 확인 (40자리)

**Railway:**
1. Project 선택 → "Variables" 탭
2. 환경 변수 확인 및 수정

#### ✅ 3단계: Build Command 확인

**Render:**
1. "Settings" 탭
2. "Build Command" 항목 확인:
   ```bash
   pip install -r requirements.txt && python download_corp_code.py
   ```

**Railway:**
1. "Settings" → "Deploy" 섹션
2. Build Command 확인

#### ✅ 4단계: 로그 확인

**Render:**
1. "Logs" 탭 클릭
2. 다음 메시지 찾기:
   ```
   ✅ 총 XXX,XXX개 회사 정보 저장됨
   ✅ X,XXX개의 회사 정보를 로드했습니다.
   ```

**오류 메시지 예시:**
```
❌ 오류: OPENDART_API_KEY가 설정되지 않았습니다.
⚠️ 경고: corp_codes.json 파일이 없습니다.
```

#### ✅ 5단계: 수동 데이터 재로드 (긴급 복구)

서버가 이미 실행 중이지만 데이터가 로드되지 않은 경우:

```bash
# POST 요청으로 데이터 재로드
curl -X POST https://your-app.onrender.com/api/reload-data
```

또는 브라우저 개발자 도구에서:
```javascript
fetch('https://your-app.onrender.com/api/reload-data', {
  method: 'POST'
})
.then(r => r.json())
.then(console.log);
```

#### ✅ 6단계: 재배포

위 방법이 모두 실패한 경우:

**Render:**
1. "Manual Deploy" 탭
2. "Clear build cache & deploy" 클릭

**Railway:**
1. "Deployments" 탭
2. "Redeploy" 클릭

---

## 🔍 문제 2: "Application failed to start" 오류

### 증상
- 배포는 성공했지만 앱이 시작되지 않음
- 502 Bad Gateway 오류

### 원인
- Gunicorn이 설치되지 않음
- Start Command가 잘못됨
- Python 버전 불일치

### 해결 방법

#### ✅ 1단계: requirements.txt 확인

`requirements.txt`에 다음이 포함되어 있는지 확인:
```
gunicorn==21.2.0
```

#### ✅ 2단계: Start Command 확인

**Render:**
```bash
gunicorn app:app
```

**Railway:**
```bash
gunicorn app:app --bind 0.0.0.0:$PORT
```

#### ✅ 3단계: runtime.txt 확인

`runtime.txt` 파일에 다음이 있는지 확인:
```
python-3.11.0
```

---

## 🔍 문제 3: 재무제표 조회 시 오류

### 증상
- 회사 검색은 되지만 재무제표를 조회하면 오류
- "조회된 데이터가 없습니다" 메시지

### 원인
- OpenDart API 키 권한 문제
- 선택한 연도에 데이터가 없음
- API 호출 제한 초과

### 해결 방법

#### ✅ 1단계: API 키 테스트

OpenDart API가 정상 작동하는지 직접 테스트:
```bash
curl "https://opendart.fss.or.kr/api/fnlttSinglAcnt.json?crtfc_key=YOUR_API_KEY&corp_code=00126380&bsns_year=2023&reprt_code=11011"
```

**정상 응답:**
```json
{
  "status": "000",
  "message": "정상",
  "list": [...]
}
```

**오류 응답:**
```json
{
  "status": "010",
  "message": "등록되지 않은 키입니다."
}
```

#### ✅ 2단계: 다른 회사/연도 시도

- 삼성전자 (005930) → 2023년 → 사업보고서
- 현대차 (005380) → 2022년 → 사업보고서

#### ✅ 3단계: API 호출 제한 확인

OpenDart API는 다음과 같은 제한이 있습니다:
- 분당 최대 요청 수 제한
- 일일 최대 요청 수 제한

로그에서 다음 메시지 확인:
```
"status": "020"  // 요청 제한 초과
```

**해결:** 잠시 기다렸다가 다시 시도

---

## 🔍 문제 4: AI 설명 기능 작동 안 함

### 증상
- "AI로 설명 듣기" 버튼 클릭 시 오류
- "Gemini API 키가 설정되지 않았습니다" 메시지

### 해결 방법

#### ✅ 1단계: Gemini API 키 확인

환경 변수에 `GEMINI_API_KEY` 추가:
```
GEMINI_API_KEY=your_gemini_api_key_here
```

#### ✅ 2단계: API 키 테스트

Google AI Studio에서 키가 유효한지 확인:
https://ai.google.dev/

#### ✅ 3단계: 재배포

환경 변수 추가 후 반드시 재배포 필요

---

## 🔍 문제 5: 슬립 모드 (Render 무료 플랜)

### 증상
- 15분 미사용 후 첫 접속 시 느림
- "웹 서비스가 슬립 모드입니다" 메시지

### 원인
- Render 무료 플랫폼의 자동 슬립 기능

### 해결 방법

#### 옵션 A: 유료 플랜 업그레이드
- $7/월 Starter 플랜
- 슬립 모드 없음

#### 옵션 B: UptimeRobot 사용 (무료)
1. https://uptimerobot.com/ 가입
2. Monitor 추가:
   - Monitor Type: HTTP(S)
   - URL: https://your-app.onrender.com/api/health
   - Monitoring Interval: 5분
3. 자동으로 5분마다 요청하여 슬립 방지

#### 옵션 C: 다른 플랫폼 사용
- Railway: $5 크레딧/월 (슬립 없음)
- AWS EC2: 완전한 제어

---

## 🔍 문제 6: CORS 오류

### 증상
- 브라우저 콘솔에 CORS 오류
- "Access-Control-Allow-Origin" 오류

### 해결 방법

`app.py`의 CORS 설정 확인:
```python
from flask_cors import CORS

# 모든 도메인 허용 (개발용)
CORS(app)

# 특정 도메인만 허용 (프로덕션)
CORS(app, resources={
    r"/api/*": {
        "origins": ["https://your-domain.com"]
    }
})
```

---

## 📊 디버깅 체크리스트

배포 후 문제가 발생하면 다음 순서대로 확인하세요:

### 1단계: Health Check
```bash
curl https://your-app.onrender.com/api/health
```
- [ ] `companies_loaded` > 0
- [ ] `api_key_configured: true`
- [ ] `data_file_exists: true`

### 2단계: 환경 변수
- [ ] `OPENDART_API_KEY` 설정됨 (40자리)
- [ ] `GEMINI_API_KEY` 설정됨 (선택사항)
- [ ] 앞뒤 공백 없음
- [ ] 따옴표 없음

### 3단계: Build & Start Commands
- [ ] Build Command에 `python download_corp_code.py` 포함
- [ ] Start Command: `gunicorn app:app`
- [ ] `requirements.txt`에 `gunicorn` 포함

### 4단계: 로그 확인
- [ ] "✅ X,XXX개의 회사 정보를 로드" 메시지 확인
- [ ] 오류 메시지 없음
- [ ] "🚀 재무제표 시각화 웹 어플리케이션 시작" 메시지 확인

### 5단계: 기능 테스트
- [ ] 메인 페이지 접속
- [ ] 회사 검색 (예: "삼성전자")
- [ ] 재무제표 조회
- [ ] AI 설명 (선택사항)

---

## 🆘 긴급 복구 절차

모든 방법이 실패한 경우:

### 1. 로그 다운로드
Render/Railway에서 전체 로그 복사

### 2. 환경 변수 재설정
모든 환경 변수 삭제 후 다시 추가

### 3. 캐시 클리어 후 재배포
```bash
# Render
"Clear build cache & deploy"

# Railway
"Redeploy"
```

### 4. 새 서비스 생성
기존 서비스 삭제 후 처음부터 다시 배포

### 5. 로컬 테스트
```bash
# 로컬에서 정상 작동 확인
python download_corp_code.py
python app.py

# 브라우저에서 http://localhost:5000 접속
```

---

## 💬 도움 요청하기

문제가 계속되면 다음 정보와 함께 GitHub Issues에 질문하세요:

1. **배포 플랫폼**: Render / Railway / AWS EC2
2. **오류 메시지**: 로그에서 복사
3. **Health Check 결과**: `/api/health` 응답
4. **환경 변수 설정 여부**: (실제 키는 숨기고)
   ```
   OPENDART_API_KEY=설정됨 (40자리)
   GEMINI_API_KEY=설정됨
   ```
5. **Build Command**: (사용한 명령)
6. **Start Command**: (사용한 명령)

---

## 📚 추가 리소스

- [Render 공식 문서](https://render.com/docs)
- [OpenDart API 가이드](https://opendart.fss.or.kr/guide/main.do)
- [Flask 배포 가이드](https://flask.palletsprojects.com/en/3.0.x/deploying/)

---

**문제가 해결되지 않으면 언제든 질문해주세요!** 🙋‍♂️

